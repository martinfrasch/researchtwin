<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join ResearchTwin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0e17; color: #e0e0e0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

        .header { text-align: center; padding: 2rem 1rem 1rem; }
        .header h1 { font-size: 2.2rem; margin-bottom: 0.3rem; background: linear-gradient(135deg, #3498db, #2ecc71); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header .tagline { font-size: 1rem; color: #8899aa; margin-bottom: 0.5rem; }
        .back-link { display: inline-block; font-size: 0.8rem; color: #3498db; text-decoration: none; margin-bottom: 1rem; }
        .back-link:hover { text-decoration: underline; }

        .container { width: 100%; max-width: 560px; padding: 0 1.5rem 3rem; }

        /* Value proposition */
        .value-props { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-bottom: 2rem; }
        .value-prop { text-align: center; padding: 1rem 0.5rem; border: 1px solid #ffffff0a; border-radius: 8px; background: #131825; }
        .value-prop .icon { font-size: 1.4rem; margin-bottom: 0.3rem; }
        .value-prop .title { font-size: 0.78rem; font-weight: 600; color: #e0e0e0; margin-bottom: 0.2rem; }
        .value-prop .desc { font-size: 0.68rem; color: #8899aa; line-height: 1.4; }

        /* Form */
        .form-section { margin-bottom: 1.5rem; }
        .form-section h3 { font-size: 0.85rem; color: #8899aa; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #ffffff0a; padding-bottom: 0.4rem; }
        .field { margin-bottom: 0.75rem; }
        .field label { display: block; font-size: 0.78rem; color: #8899aa; margin-bottom: 0.25rem; }
        .field label .req { color: #e74c3c; }
        .field input {
            width: 100%; background: #131825; border: 1px solid #3498db33; color: #e0e0e0;
            border-radius: 6px; padding: 0.55rem 0.75rem; font-size: 0.88rem; font-family: inherit;
            transition: border-color 0.2s;
        }
        .field input:focus { outline: none; border-color: #3498db; }
        .field input::placeholder { color: #556677; }
        .field .helper { font-size: 0.68rem; color: #556677; margin-top: 0.2rem; }
        .field .helper a { color: #3498db; text-decoration: none; }
        .field .helper a:hover { text-decoration: underline; }
        .field.error input { border-color: #e74c3c; }
        .field.error .helper { color: #e74c3c; }
        .honeypot { position: absolute; left: -9999px; opacity: 0; height: 0; }

        .ids-note { font-size: 0.75rem; color: #8899aa; line-height: 1.5; margin-bottom: 0.75rem; }

        .submit-btn {
            width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-size: 0.95rem;
            font-weight: 600; font-family: inherit; cursor: pointer; color: #fff;
            background: linear-gradient(135deg, #3498db, #2ecc71); transition: opacity 0.2s;
        }
        .submit-btn:hover { opacity: 0.9; }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .error-msg { background: #e74c3c22; border: 1px solid #e74c3c44; color: #e74c3c; border-radius: 6px; padding: 0.5rem 0.75rem; font-size: 0.82rem; margin-bottom: 1rem; display: none; }

        /* Success screen */
        .success { display: none; text-align: center; }
        .success h2 { font-size: 1.4rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #3498db, #2ecc71); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .success .slug-display {
            display: inline-block; background: #131825; border: 1px solid #2ecc7144; border-radius: 6px;
            padding: 0.4rem 1rem; font-family: 'SF Mono', Consolas, monospace; font-size: 1rem;
            color: #2ecc71; margin: 0.75rem 0;
        }
        .success .view-link {
            display: inline-block; margin-top: 1rem; padding: 0.6rem 1.5rem; border-radius: 8px;
            background: linear-gradient(135deg, #3498db, #2ecc71); color: #fff; text-decoration: none;
            font-weight: 600; font-size: 0.9rem; transition: opacity 0.2s;
        }
        .success .view-link:hover { opacity: 0.9; }
        .success .embed-section { margin-top: 1.5rem; text-align: left; }
        .success .embed-section h4 { font-size: 0.8rem; color: #8899aa; margin-bottom: 0.4rem; }
        .success .embed-code {
            width: 100%; background: #0a0e17; border: 1px solid #ffffff0a; border-radius: 6px;
            padding: 0.6rem; font-family: 'SF Mono', Consolas, monospace; font-size: 0.72rem;
            color: #2ecc71; resize: none; height: 3.5rem;
        }

        /* Self-host section */
        .selfhost {
            margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid #ffffff0a;
        }
        .selfhost-toggle {
            background: none; border: none; color: #556677; cursor: pointer;
            font-family: inherit; font-size: 0.78rem; display: flex; align-items: center; gap: 0.3rem;
        }
        .selfhost-toggle:hover { color: #8899aa; }
        .selfhost-toggle .arrow { transition: transform 0.2s; display: inline-block; }
        .selfhost-toggle .arrow.open { transform: rotate(90deg); }
        .selfhost-content { display: none; margin-top: 1rem; }
        .selfhost-content.visible { display: block; }
        .selfhost-instructions {
            background: #131825; border: 1px solid #3498db33; border-radius: 8px; padding: 1.25rem;
            font-size: 0.82rem; line-height: 1.6;
        }
        .selfhost-instructions h4 { font-size: 0.88rem; color: #e0e0e0; margin-bottom: 0.75rem; }
        .selfhost-instructions .step { margin-bottom: 0.4rem; }
        .selfhost-instructions .step-num { color: #3498db; font-weight: 600; margin-right: 0.3rem; }
        .selfhost-instructions code {
            display: block; background: #0a0e17; border: 1px solid #ffffff0a; border-radius: 4px;
            padding: 0.35rem 0.6rem; font-family: 'SF Mono', Consolas, monospace; font-size: 0.75rem;
            color: #2ecc71; margin: 0.25rem 0; overflow-x: auto;
        }
        .selfhost-instructions .prereqs { color: #8899aa; font-size: 0.72rem; margin-top: 0.75rem; border-top: 1px solid #ffffff0a; padding-top: 0.5rem; }

        /* How-to embed section */
        .howto {
            margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid #ffffff0a;
        }
        .howto h2 {
            font-size: 1.3rem; margin-bottom: 0.3rem;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .howto .subtitle { font-size: 0.85rem; color: #8899aa; margin-bottom: 1.25rem; }
        .howto .preview-frame {
            border: 1px solid #3498db33; border-radius: 10px; overflow: hidden;
            margin-bottom: 1.25rem; background: #131825;
        }
        .howto .preview-frame iframe { display: block; }
        .howto .steps { list-style: none; padding: 0; }
        .howto .steps li {
            margin-bottom: 1rem; padding-left: 1.6rem; position: relative;
            font-size: 0.85rem; line-height: 1.6; color: #c0c8d0;
        }
        .howto .steps li::before {
            content: attr(data-step);
            position: absolute; left: 0; color: #3498db; font-weight: 700; font-size: 0.9rem;
        }
        .howto .steps li strong { color: #e0e0e0; }
        .howto .code-block {
            display: block; background: #0a0e17; border: 1px solid #ffffff0a; border-radius: 6px;
            padding: 0.6rem 0.75rem; font-family: 'SF Mono', Consolas, monospace; font-size: 0.75rem;
            color: #2ecc71; margin: 0.4rem 0; overflow-x: auto; white-space: pre; cursor: pointer;
            position: relative;
        }
        .howto .code-block:hover { border-color: #3498db44; }
        .howto .code-block .copy-hint {
            position: absolute; top: 0.4rem; right: 0.5rem; font-size: 0.6rem; color: #556677;
        }
        .howto .platform-note {
            font-size: 0.75rem; color: #718096; margin-top: 0.5rem; line-height: 1.5;
        }
        .howto .platform-note strong { color: #8899aa; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ResearchTwin</h1>
        <p class="tagline">Create your research digital twin in 60 seconds</p>
        <a href="/" class="back-link">&larr; Back to dashboard</a>
    </div>

    <div class="container">
        <!-- Value proposition -->
        <div class="value-props">
            <div class="value-prop">
                <div class="icon">&#x1f4ca;</div>
                <div class="title">S-Index Score</div>
                <div class="desc">Quality, Impact &amp; Collaboration across all your outputs</div>
            </div>
            <div class="value-prop">
                <div class="icon">&#x1f578;&#xfe0f;</div>
                <div class="desc" style="font-size:0.68rem;">
                <div class="title">Knowledge Graph</div>
                Interactive visualization of your papers, code &amp; datasets</div>
            </div>
            <div class="value-prop">
                <div class="icon">&#x1f916;</div>
                <div class="title">AI Discovery</div>
                <div class="desc">Machine-readable API for agent-to-agent research discovery</div>
            </div>
        </div>

        <!-- Registration form -->
        <div id="form-content">
            <div class="error-msg" id="error-msg"></div>

            <form id="register-form" onsubmit="handleSubmit(event)">
                <div class="form-section">
                    <h3>About You</h3>
                    <div class="field">
                        <label>Full Name <span class="req">*</span></label>
                        <input type="text" name="name" required minlength="2" maxlength="100" placeholder="Jane Doe">
                    </div>
                    <div class="field">
                        <label>Email <span class="req">*</span></label>
                        <input type="email" name="email" required maxlength="254" placeholder="jane@university.edu">
                        <div class="helper">Used for profile updates only. Never shared.</div>
                    </div>
                    <!-- Honeypot -->
                    <div class="honeypot" aria-hidden="true">
                        <label>Website</label>
                        <input type="text" name="website" tabindex="-1" autocomplete="off">
                    </div>
                </div>

                <div class="form-section">
                    <h3>Connect Your Research Accounts</h3>
                    <p class="ids-note">These IDs let us fetch your publications, code, and datasets. Add what you have now; you can <a href="/update.html" style="color:#3498db;">update later</a>.</p>
                    <div class="field">
                        <label>Semantic Scholar ID</label>
                        <input type="text" name="semantic_scholar_id" maxlength="20" placeholder="e.g. 4019392">
                        <div class="helper"><a href="https://www.semanticscholar.org/me" target="_blank">Find your ID</a> &mdash; it's the number in your profile URL</div>
                    </div>
                    <div class="field">
                        <label>Google Scholar ID</label>
                        <input type="text" name="google_scholar_id" maxlength="20" placeholder="e.g. 3lacmuYAAAAJ">
                        <div class="helper">The string after <code style="display:inline; background:#131825; padding:0.1rem 0.3rem; border-radius:3px; font-size:0.72rem; color:#e67e22;">user=</code> in your <a href="https://scholar.google.com/" target="_blank">Scholar profile URL</a></div>
                    </div>
                    <div class="field">
                        <label>GitHub Username</label>
                        <input type="text" name="github_username" maxlength="39" placeholder="e.g. janedoe">
                        <div class="helper">Your GitHub handle (we'll pull public repos)</div>
                    </div>
                    <div class="field">
                        <label>Figshare Author Name</label>
                        <input type="text" name="figshare_search_name" maxlength="100" placeholder="e.g. Jane Doe">
                        <div class="helper">Only if you have datasets on <a href="https://figshare.com/" target="_blank">Figshare</a>. Leave blank otherwise.</div>
                    </div>
                    <div class="field">
                        <label>ORCID</label>
                        <input type="text" name="orcid" maxlength="25" placeholder="e.g. 0000-0003-3159-6321">
                        <div class="helper"><a href="https://orcid.org/" target="_blank">orcid.org</a> &mdash; your persistent researcher identifier</div>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">Create My Digital Twin</button>
            </form>
        </div>

        <!-- Success screen -->
        <div class="success" id="success">
            <h2>Your ResearchTwin is Live!</h2>
            <p style="color:#8899aa; margin-bottom:0.5rem">Your researcher slug:</p>
            <div class="slug-display" id="slug-display"></div>
            <br>
            <a href="/" class="view-link" id="view-link">View Your Digital Twin &rarr;</a>
            <p style="color:#8899aa; font-size:0.8rem; margin-top:1rem;">Need to add or change your research IDs later? <a href="/update.html" style="color:#3498db;" id="update-link">Update your profile</a></p>
            <div class="embed-section">
                <h4>Embed your S-Index on your lab website (copy this code)</h4>
                <textarea class="embed-code" id="embed-code" readonly></textarea>
            </div>
            <div class="embed-section" style="margin-top:1rem;">
                <h4>Embed the Chat Widget (visitors bring their own LLM key)</h4>
                <textarea class="embed-code" id="chat-embed-code" readonly style="height:3.5rem;"></textarea>
            </div>
        </div>

        <!-- Self-host option (collapsed by default) -->
        <div class="selfhost">
            <button class="selfhost-toggle" onclick="toggleSelfhost()">
                <span class="arrow" id="selfhost-arrow">&#x25b6;</span>
                Want to self-host your own instance instead?
            </button>
            <div class="selfhost-content" id="selfhost-content">
                <div class="selfhost-instructions">
                    <h4>Run Your Own ResearchTwin Node</h4>
                    <div class="step"><span class="step-num">1.</span> Clone the repository</div>
                    <code>git clone https://github.com/martinfrasch/researchtwin.git && cd researchtwin</code>
                    <div class="step"><span class="step-num">2.</span> Install dependencies</div>
                    <code>pip install -r backend/requirements.txt</code>
                    <div class="step"><span class="step-num">3.</span> Configure your profile</div>
                    <code>cp node_config.json.example node_config.json && nano node_config.json</code>
                    <div class="step"><span class="step-num">4.</span> Set your Perplexity API key (for chat)</div>
                    <code>export PERPLEXITY_API_KEY=pplx-...</code>
                    <div class="step"><span class="step-num">5.</span> Launch your node</div>
                    <code>python run_node.py --config node_config.json</code>
                    <p class="prereqs">Prerequisites: Python 3.10+, Perplexity API key (for chat). All data connectors (Semantic Scholar, GitHub, Figshare) work without keys.</p>
                </div>
            </div>
        </div>

        <!-- How to embed section -->
        <div class="howto" id="howto">
            <h2>Embed Your S-Index</h2>
            <p class="subtitle">Show your S-Index on your lab website, Google Sites page, or personal homepage.</p>

            <div class="preview-frame" id="embed-preview">
                <div style="height:180px; display:flex; align-items:center; justify-content:center; color:#556677; font-size:0.82rem;">
                    Your S-Index widget preview will appear here after registration
                </div>
            </div>

            <ol class="steps">
                <li data-step="1.">
                    <strong>Copy the embed code</strong> below<span id="slug-instruction">, replacing <code style="display:inline; background:#131825; padding:0.15rem 0.4rem; border-radius:3px; font-size:0.78rem; color:#e67e22;">YOUR-SLUG</code> with your researcher slug</span>:
                    <span class="code-block" id="howto-embed-code" onclick="copyCode(this)">&lt;iframe src="https://researchtwin.net/embed.html?slug=YOUR-SLUG" width="440" height="180" style="border:none; border-radius:12px;" loading="lazy"&gt;&lt;/iframe&gt;<span class="copy-hint">click to copy</span></span>
                </li>
                <li data-step="2.">
                    <strong>Paste it into your website:</strong>
                    <p class="platform-note">
                        <strong>Google Sites:</strong> Edit your page &rarr; Insert &rarr; Embed &rarr; "By URL" tab &rarr; paste <code style="display:inline; background:#131825; padding:0.1rem 0.35rem; border-radius:3px; font-size:0.75rem; color:#2ecc71;">https://researchtwin.net/embed.html?slug=YOUR-SLUG</code><br>
                        <strong>WordPress:</strong> Add a Custom HTML block &rarr; paste the iframe code<br>
                        <strong>Any HTML page:</strong> Paste the iframe code directly into your HTML
                    </p>
                </li>
                <li data-step="3.">
                    <strong>Done!</strong> The widget fetches live data and updates automatically as your research profile grows.
                </li>
            </ol>
        </div>

        <!-- How to embed chat widget section -->
        <div class="howto" id="howto-chat">
            <h2>Embed Your Chat Widget</h2>
            <p class="subtitle">Let visitors chat with your Digital Twin using their own LLM API key (no cost to you).</p>

            <div class="preview-frame" id="chat-preview">
                <div style="height:260px; display:flex; align-items:center; justify-content:center; color:#556677; font-size:0.82rem;">
                    Your chat widget preview will appear here after registration
                </div>
            </div>

            <ol class="steps">
                <li data-step="1.">
                    <strong>Copy the embed code</strong> below<span id="chat-slug-instruction">, replacing <code style="display:inline; background:#131825; padding:0.15rem 0.4rem; border-radius:3px; font-size:0.78rem; color:#e67e22;">YOUR-SLUG</code> with your researcher slug</span>:
                    <span class="code-block" id="howto-chat-code" onclick="copyCode(this)">&lt;iframe src="https://researchtwin.net/chat-widget.html?slug=YOUR-SLUG" width="400" height="500" style="border:none; border-radius:12px;" loading="lazy"&gt;&lt;/iframe&gt;<span class="copy-hint">click to copy</span></span>
                </li>
                <li data-step="2.">
                    <strong>Paste it into your website.</strong> Visitors choose a provider (Perplexity or OpenAI) and enter their own API key inside the widget. Keys are sent per-request and never stored.
                    <p class="platform-note">
                        <strong>Google Sites:</strong> Edit your page &rarr; Insert &rarr; Embed &rarr; "By URL" tab &rarr; paste <code style="display:inline; background:#131825; padding:0.1rem 0.35rem; border-radius:3px; font-size:0.75rem; color:#2ecc71;">https://researchtwin.net/chat-widget.html?slug=YOUR-SLUG</code><br>
                        <strong>WordPress:</strong> Add a Custom HTML block &rarr; paste the iframe code<br>
                        <strong>Any HTML page:</strong> Paste the iframe code directly into your HTML
                    </p>
                </li>
                <li data-step="3.">
                    <strong>Done!</strong> The widget uses the visitor's API key to power conversations about your research. Your data stays on ResearchTwin; only the LLM call uses their key.
                </li>
            </ol>
        </div>
    </div>

    <script>
        function toggleSelfhost() {
            const content = document.getElementById('selfhost-content');
            const arrow = document.getElementById('selfhost-arrow');
            content.classList.toggle('visible');
            arrow.classList.toggle('open');
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('submit-btn');
            const errEl = document.getElementById('error-msg');

            errEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Creating...';

            const data = {
                name: form.name.value.trim(),
                email: form.email.value.trim(),
                tier: 3,
                semantic_scholar_id: form.semantic_scholar_id.value.trim(),
                google_scholar_id: form.google_scholar_id.value.trim(),
                github_username: form.github_username.value.trim(),
                figshare_search_name: form.figshare_search_name.value.trim(),
                orcid: form.orcid.value.trim(),
                website: form.website.value,
            };

            try {
                const resp = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Registration failed');
                }

                const result = await resp.json();
                showSuccess(result);
            } catch (err) {
                errEl.textContent = err.message;
                errEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Create My Digital Twin';
            }
        }

        function showSuccess(result) {
            document.getElementById('form-content').style.display = 'none';
            document.querySelector('.value-props').style.display = 'none';

            const successEl = document.getElementById('success');
            successEl.style.display = 'block';
            document.getElementById('slug-display').textContent = result.slug;
            document.getElementById('view-link').href = `/?researcher=${result.slug}`;
            document.getElementById('update-link').href = `/update.html?slug=${result.slug}`;
            document.getElementById('embed-code').value =
                `<iframe src="https://researchtwin.net/embed.html?slug=${result.slug}" width="440" height="180" style="border:none; border-radius:12px;" loading="lazy"></iframe>`;

            const preview = document.getElementById('embed-preview');
            if (preview) preview.innerHTML = `<iframe src="/embed.html?slug=${result.slug}" width="100%" height="180" style="border:none;" loading="lazy"></iframe>`;

            // Update the howto embed code with the actual slug
            const howtoCode = document.getElementById('howto-embed-code');
            if (howtoCode) {
                const hint = howtoCode.querySelector('.copy-hint');
                howtoCode.textContent = `<iframe src="https://researchtwin.net/embed.html?slug=${result.slug}" width="440" height="180" style="border:none; border-radius:12px;" loading="lazy"></iframe>`;
                if (hint) howtoCode.appendChild(hint);
            }
            const slugInstr = document.getElementById('slug-instruction');
            if (slugInstr) slugInstr.innerHTML = ` (your slug: <code style="display:inline; background:#131825; padding:0.1rem 0.3rem; border-radius:3px; font-size:0.78rem; color:#2ecc71;">${result.slug}</code>)`;

            // Chat widget embed code
            const chatCode = document.getElementById('chat-embed-code');
            if (chatCode) chatCode.value = `<iframe src="https://researchtwin.net/chat-widget.html?slug=${result.slug}" width="400" height="500" style="border:none; border-radius:12px;" loading="lazy"></iframe>`;

            const chatPreview = document.getElementById('chat-preview');
            if (chatPreview) chatPreview.innerHTML = `<iframe src="/chat-widget.html?slug=${result.slug}" width="100%" height="500" style="border:none;" loading="lazy"></iframe>`;

            const howtoChatCode = document.getElementById('howto-chat-code');
            if (howtoChatCode) {
                const hint = howtoChatCode.querySelector('.copy-hint');
                howtoChatCode.textContent = `<iframe src="https://researchtwin.net/chat-widget.html?slug=${result.slug}" width="400" height="500" style="border:none; border-radius:12px;" loading="lazy"></iframe>`;
                if (hint) howtoChatCode.appendChild(hint);
            }
            const chatSlugInstr = document.getElementById('chat-slug-instruction');
            if (chatSlugInstr) chatSlugInstr.innerHTML = ` (your slug: <code style="display:inline; background:#131825; padding:0.1rem 0.3rem; border-radius:3px; font-size:0.78rem; color:#2ecc71;">${result.slug}</code>)`;
        }

        function copyCode(el) {
            const text = el.childNodes[0].textContent;
            navigator.clipboard.writeText(text).then(() => {
                const hint = el.querySelector('.copy-hint');
                if (hint) { hint.textContent = 'copied!'; setTimeout(() => hint.textContent = 'click to copy', 1500); }
            });
        }
    </script>
</body>
</html>
